# Sarcoin Local Test Dockerfile
# Multi-stage build: compiles geth from source inside Docker

# Build stage
FROM golang:1.23-bookworm AS builder

WORKDIR /build

# Copy go.mod and go.sum first (better caching)
COPY go.mod go.sum ./

# Download dependencies with Go 1.24+ auto-download
RUN GOTOOLCHAIN=auto go mod download

# Copy source code
COPY . .

# Build geth with Go 1.24+
RUN GOTOOLCHAIN=auto go build -v -o geth ./cmd/geth

# Runtime stage
FROM ubuntu:22.04

# Install runtime dependencies
RUN apt-get update && apt-get install -y \
    ca-certificates \
    libstdc++6 \
    && rm -rf /var/lib/apt/lists/*

# Create data directory
RUN mkdir -p /root/.sarcoin

# Copy compiled binary from builder stage
COPY --from=builder /build/geth /usr/local/bin/geth
RUN chmod +x /usr/local/bin/geth

# Copy genesis files
COPY genesis-testnet.json /genesis-testnet.json
COPY genesis-mainnet.json /genesis-mainnet.json

# Expose ports
EXPOSE 8545 8546 30303 30303/udp

# Working directory
WORKDIR /root

# Default command
ENTRYPOINT ["geth"]
CMD ["--help"]
