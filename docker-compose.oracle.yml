version: "3.8"

# Sarcoin Network - Oracle Cloud Always Free Deployment
# Optimized for 2x VM.Standard.E2.1.Micro (1 GB RAM each)

services:
  # RPC Node - Deploy on VM 1
  sarcoin-rpc:
    image: sarcoin/node:latest
    build:
      context: .
      dockerfile: Dockerfile.sarcoin
    container_name: sarcoin-rpc
    command: >
      --datadir /data
      --networkid 3901
      --http
      --http.addr 0.0.0.0
      --http.port 8545
      --http.api eth,net,web3,txpool
      --http.vhosts *
      --http.corsdomain *
      --ws
      --ws.addr 0.0.0.0
      --ws.port 8546
      --ws.api eth,net,web3
      --ws.origins *
      --syncmode snap
      --cache 768
      --maxpeers 30
      --verbosity 3
      --metrics
      --pprof
      --pprof.addr 0.0.0.0
    ports:
      - "8545:8545"
      - "8546:8546"
      - "30303:30303"
      - "30303:30303/udp"
      - "6060:6060"
    volumes:
      - rpc-data:/data
    restart: unless-stopped
    mem_limit: 900m
    mem_reservation: 768m

  # Validator Node - Deploy on VM 2
  sarcoin-validator:
    image: sarcoin/node:latest
    build:
      context: .
      dockerfile: Dockerfile.sarcoin
    container_name: sarcoin-validator
    command: >
      --datadir /data
      --networkid 3901
      --port 30303
      --mine
      --miner.etherbase ${VALIDATOR_ADDRESS:-0x538C13ad0d2B4445a3ED9dE25bA2629a58612F20}
      --unlock ${VALIDATOR_ADDRESS:-0x538C13ad0d2B4445a3ED9dE25bA2629a58612F20}
      --password /secrets/password.txt
      --allow-insecure-unlock
      --syncmode snap
      --cache 768
      --maxpeers 30
      --verbosity 3
      --metrics
    ports:
      - "30303:30303"
      - "30303:30303/udp"
      - "6060:6060"
    volumes:
      - validator-data:/data
      - ./validators/validator1/keystore:/data/keystore:ro
      - ./validators/password.txt:/secrets/password.txt:ro
    restart: unless-stopped
    mem_limit: 900m
    mem_reservation: 768m
    environment:
      - VALIDATOR_ADDRESS=${VALIDATOR_ADDRESS}

volumes:
  rpc-data:
    driver: local
  validator-data:
    driver: local
